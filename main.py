import os
import threading
import asyncio
from telegram import (
    Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardRemove
)
from telegram.ext import (
    ApplicationBuilder, CommandHandler, ContextTypes,
    ConversationHandler, MessageHandler, filters, CallbackQueryHandler
)
from flask import Flask

BOT_TOKEN = os.getenv("BOT_TOKEN")

flask_app = Flask(__name__)
@flask_app.route('/')
def home():
    return "‚úÖ GlovoPromoBot –ø—Ä–∞—Ü—é—î!"

def run_flask():
    flask_app.run(host="0.0.0.0", port=8080)

# --- –°—Å—ã–ª–∫–∏ (–í–°–¢–ê–í–¨ –°–í–û–ò!!!)
LINK_PODTV = "https://t.me/YOUR_CHANNEL_CONFIRM"
LINK_18_YES = "https://t.me/YOUR_CHANNEL_18_YES"
LINK_18_NO = "https://t.me/YOUR_CHANNEL_18_NO"
LINK_MAN = "https://t.me/YOUR_CHANNEL_MAN"
LINK_WOMAN = "https://t.me/YOUR_CHANNEL_WOMAN"
LINK_UA = "https://t.me/YOUR_CHANNEL_UA"
LINK_NOT_UA = "https://t.me/YOUR_CHANNEL_NOTUA"
REGION_LINKS = {
    'east': "https://t.me/YOUR_CHANNEL_EAST",
    'central': "https://t.me/YOUR_CHANNEL_CENTRAL",
    'west': "https://t.me/YOUR_CHANNEL_WEST",
    'south': "https://t.me/YOUR_CHANNEL_SOUTH",
    'north': "https://t.me/YOUR_CHANNEL_NORTH",
}

# --- –°—Ç–µ–π—Ç—ã
(
    STEP_CONFIRM, STEP_SERVICE, STEP_SUM,
    STEP_FINAL_CONFIRM, STEP_ANTIBOT,
    STEP_18, STEP_GENDER, STEP_UA, STEP_REGION, STEP_DONE
) = range(10)

user_data = {}

SERVICES = ["Glovo", "KFC", "McDonald‚Äôs", "–°—É—à—ñ—è", "Dominos Pizza"]
SUMS = ["100 –≥—Ä–Ω", "500 –≥—Ä–Ω", "1000 –≥—Ä–Ω", "2000 –≥—Ä–Ω"]

CERT_BLUR_IMG = {
    "Glovo": "glovo_cert_blur_v1.jpg",
    "KFC": "kfc_cert_blur_v1.jpg",
    "McDonald‚Äôs": "mcd_cert_blur_v1.jpg",
    "–°—É—à—ñ—è": "sushiya_cert_blur_v1.jpg",
    "Dominos Pizza": "dominos_cert_blur_v1.jpg"
}
CERT_FINAL_IMG = {
    "Glovo": "glovo_cert_final.jpg",
    "KFC": "kfc_cert_final.jpg",
    "McDonald‚Äôs": "mcd_cert_final.jpg",
    "–°—É—à—ñ—è": "sushiya_cert_final.jpg",
    "Dominos Pizza": "dominos_cert_final.jpg"
}
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_user.id
    user_data[chat_id] = {}
    # 0. Welcome: —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∏ —Ç–µ–∫—Å—Ç
    with open("2.jpeg", "rb") as img:
        await context.bot.send_photo(
            chat_id=chat_id, photo=img,
            caption=(
                "üçî –í—ñ—Ç–∞—î–º–æ –≤ –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç-–ë–æ—Ç—ñ!\n\n"
                "‚ö†Ô∏è –£–≤–∞–≥–∞!\n"
                "–ó–∞–ª–∏—à–∏–ª–æ—Å—å 113 —ñ–∑ 12 000 —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤\n\n"
                "üî• –ó–∞—Ä–∞–∑ –¥–æ—Å—Ç—É–ø–Ω—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –Ω–∞:\n"
                "‚Äî Glovo\n‚Äî KFC\n‚Äî McDonald‚Äôs\n‚Äî –°—É—à—ñ—è\n‚Äî Dominos Pizza\n\n"
                "–ù–∞ —Å—É–º–∏: 100, 500, 1000 —ñ 2000 –≥—Ä–Ω"
            )
        )
    # –û—Ç–¥–µ–ª—å–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏!"
    await context.bot.send_message(
        chat_id,
        "–ì–æ—Ç–æ–≤—ñ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–≤—ñ–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –ø—Ä—è–º–æ –∑–∞—Ä–∞–∑?\n"
        "–°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å, —â–æ –≤–∏ –Ω–µ –±–æ—Ç ü§ñ",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏!", url=LINK_PODTV)]
        ])
    )
    await asyncio.sleep(3)
    # 1. –í—ã–±–æ—Ä —Å–µ—Ä–≤–∏—Å–∞
    await context.bot.send_message(
        chat_id, "–û–±–µ—Ä—ñ—Ç—å —Å–µ—Ä–≤—ñ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –∞–±–æ –∑–∞–∫–ª–∞–¥ —Ñ–∞—Å—Ç—Ñ—É–¥—É:",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton(name, callback_data=f"srv_{name}")]
            for name in SERVICES
        ])
    )
    return STEP_SERVICE


async def handle_service(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    chat_id = query.from_user.id
    service = query.data.replace("srv_", "")
    user_data[chat_id]["service"] = service
    # 2. –í—ã–±–æ—Ä —Å—É–º–º—ã
    await context.bot.send_message(
        chat_id,
        "–í–∞—à —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –º–∞–π–∂–µ –≥–æ—Ç–æ–≤–∏–π! –û–±–µ—Ä—ñ—Ç—å —Å—É–º—É:",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton(s, callback_data=f"sum_{s}")] for s in SUMS
        ])
    )
    return STEP_SUM

async def handle_sum(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    chat_id = query.from_user.id
    s = query.data.replace("sum_", "")
    user_data[chat_id]["sum"] = s
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ + –∫–Ω–æ–ø–∫–∞
    await context.bot.send_message(
        chat_id,
        f"–î—è–∫—É—î–º–æ! –ü–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –≤–∞—à –≤–∏–±—ñ—Ä:\n–°–µ—Ä–≤—ñ—Å ‚Äî {user_data[chat_id]['service']}, –°—É–º–∞ ‚Äî {s}",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏", callback_data="final_confirm")]
        ])
    )
    return STEP_FINAL_CONFIRM

async def handle_final_confirm(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    chat_id = query.from_user.id
    service = user_data[chat_id]['service']
    # 3.1 –ë–ª—é—Ä —Ñ–æ—Ç–æ + –∫–Ω–æ–ø–∫–∞ ‚Äú–ü—Ä–æ–π—Ç–∏‚Äù
    with open(CERT_BLUR_IMG[service], "rb") as img:
        await context.bot.send_photo(
            chat_id=chat_id,
            photo=img,
            caption="–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ ‚úÖ\n–ß–µ—Ä–µ–∑ –ø—ñ–¥–æ–∑—Ä—ñ–ª—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –±–æ—Ç—ñ–≤, —Ç—Ä–µ–±–∞ –ø—Ä–æ–π—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É.",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("–ü—Ä–æ–π—Ç–∏", url=LINK_PODTV)]
            ])
        )
    await asyncio.sleep(3)
    # 4. –í—ñ–∫
    with open("1.jpeg", "rb") as img:
        await context.bot.send_photo(
            chat_id=chat_id,
            photo=img,
            caption="–¢–æ–±—ñ –≤–∂–µ —î 18 —Ä–æ–∫—ñ–≤?",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("–¢–∞–∫", url=LINK_18_YES)],
                [InlineKeyboardButton("–ù—ñ", url=LINK_18_NO)],
            ])
        )
    await asyncio.sleep(3)
    # 4.1 –°—Ç–∞—Ç—å
    with open("3.jpeg", "rb") as img:
        await context.bot.send_photo(
            chat_id=chat_id,
            photo=img,
            caption="–í–∏–±–µ—Ä–∏ —Å–≤–æ—é —Å—Ç–∞—Ç—å:",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üë® –ß–æ–ª–æ–≤—ñ—á–∞", url=LINK_MAN)],
                [InlineKeyboardButton("üë© –ñ—ñ–Ω–æ—á–∞", url=LINK_WOMAN)],
            ])
        )
    await asyncio.sleep(3)
    # 5. –£–∫—Ä–∞—ó–Ω–µ—Ü—å
    await context.bot.send_message(
        chat_id,
        "–¢–∏ –∑ –£–∫—Ä–∞—ó–Ω–∏?",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("–Ø —É–∫—Ä–∞—ó–Ω–µ—Ü—å üá∫üá¶", url=LINK_UA)],
            [InlineKeyboardButton("–ù—ñ", url=LINK_NOT_UA)]
        ])
    )
    await asyncio.sleep(3)
    # 6. –†–µ–≥—ñ–æ–Ω
    with open("4.jpeg", "rb") as img:
        await context.bot.send_photo(
            chat_id=chat_id,
            photo=img,
            caption="–ó —è–∫–æ–≥–æ —Ç–∏ —Ä–µ–≥—ñ–æ–Ω—É?",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üá∫üá¶ –°—Ö—ñ–¥–Ω–∞ –£–∫—Ä–∞—ó–Ω–∞", url=REGION_LINKS['east'])],
                [InlineKeyboardButton("üá∫üá¶ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞ –£–∫—Ä–∞—ó–Ω–∞", url=REGION_LINKS['central'])],
                [InlineKeyboardButton("üá∫üá¶ –ó–∞—Ö—ñ–¥–Ω–∞ –£–∫—Ä–∞—ó–Ω–∞", url=REGION_LINKS['west'])],
                [InlineKeyboardButton("üá∫üá¶ –ü—ñ–≤–¥–µ–Ω–Ω–∞ –£–∫—Ä–∞—ó–Ω–∞", url=REGION_LINKS['south'])],
                [InlineKeyboardButton("üá∫üá¶ –ü—ñ–≤–Ω—ñ—á–Ω–∞ –£–∫—Ä–∞—ó–Ω–∞", url=REGION_LINKS['north'])],
            ])
        )
    await asyncio.sleep(3)
    # 7. –§–∏–Ω–∞–ª ‚Äî –≤—ã–¥–∞—á–∞ —Å–µ—Ä—Ç–∞
    with open(CERT_FINAL_IMG[service], "rb") as img:
        await context.bot.send_photo(
            chat_id=chat_id,
            photo=img,
            caption=(
                f"üéâ –¢–≤—ñ–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –≥–æ—Ç–æ–≤–∏–π! –ü–æ–∫–∞–∂–∏ –π–æ–≥–æ –Ω–∞ –∫–∞—Å—ñ —É –∑–∞–∫–ª–∞–¥—ñ {service}. –°—É–º–∞: {user_data[chat_id]['sum']}"
            )
        )
    return ConversationHandler.END

def main():
    threading.Thread(target=run_flask, daemon=True).start()
    app = ApplicationBuilder().token(BOT_TOKEN).build()
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start)],
        states={
            STEP_SERVICE: [CallbackQueryHandler(handle_service, pattern=r"^srv_")],
            STEP_SUM: [CallbackQueryHandler(handle_sum, pattern=r"^sum_")],
            STEP_FINAL_CONFIRM: [CallbackQueryHandler(handle_final_confirm, pattern=r"^final_confirm$")],
        },
        fallbacks=[CommandHandler('start', start)],
        allow_reentry=True
    )
    app.add_handler(conv_handler)
    app.run_polling()

if __name__ == "__main__":
    main()
